// src/lib/api.js
// ============================================================
// ì´ íŒŒì¼ì€ "ì•± ì „ì—­ì—ì„œ ë‹¨ í•˜ë‚˜ë§Œ" ì‚¬ìš©í•˜ëŠ” Axios ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë§Œë“ ë‹¤.
// - baseURL: '/localhost:80' (ê°œë°œ í”„ë¡ì‹œ ê¸°ì¤€)
// - withCredentials: true (ë¦¬í”„ë ˆì‹œ í† í° ì¿ í‚¤ ìë™ ì „ì†¡)
// - ìš”ì²­ ì¸í„°ì…‰í„°: Piniaì˜ access tokenì„ Authorization í—¤ë”ë¡œ ìë™ ë¶€ì°©
// - ì‘ë‹µ ì¸í„°ì…‰í„°: 401 ë‚˜ì˜¤ë©´ /auth/refresh ìë™ í˜¸ì¶œ â†’ ì„±ê³µ ì‹œ ì›ìš”ì²­ ì¬ì‹œë„
// ============================================================

import axios from 'axios';                  // axios ë³¸ì²´ë¥¼ ê°€ì ¸ì˜¨ë‹¤.
import { useUserStore } from '@/stores/user'; // Piniaì˜ ì‚¬ìš©ì ìŠ¤í† ì–´(ì•¡ì„¸ìŠ¤ í† í°ì„ êº¼ë‚´ì˜¤ê¸° ìœ„í•¨)
import { useToast } from '@/lib/toast'
import router from '@/router/index.routes';
import {isTokenExpired} from '@/lib/jwtUtil';

const {success, error : toastError , info} = useToast();
// ë‚ ì§œ í•œêµ­ ì‹œê°„ìœ¼ë¡œ ì¶œë ¥í•˜ê¸°
const formattedTimeForKor =  () => {
  const now = new Date();
  const formatted = now.toLocaleString('ko-KR', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit',
    hour12: false
  }).replace(/\./g, '').replace(/ /g, '-').replace('ì˜¤ì „', '').replace('ì˜¤í›„', '');

  return formatted;
}

const API_BASE_URL = (import.meta.env?.VITE_API_BASE_URL || 'http://localhost:8081').replace(/\/$/, '');

// ------------------------------------------------------------
// 1) ì „ì—­ì—ì„œ ì“¸ Axios ì¸ìŠ¤í„´ìŠ¤ 1ê°œ ìƒì„±
// ------------------------------------------------------------
const api = axios.create({
  // baseURL: API_BASE_URL,          // ëª¨ë“  ìƒëŒ€ ê²½ë¡œ ìš”ì²­ì€ '/localhost:80'ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë³´ë‚¸ë‹¤. (Vite dev proxyë¡œ ë°±ì—”ë“œ ì—°ê²° ê°€ì •)
  // baseURL: 'http://localhost:80/back',          // ëª¨ë“  ìƒëŒ€ ê²½ë¡œ ìš”ì²­ì€ '/localhost:80'ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë³´ë‚¸ë‹¤. (Vite dev proxyë¡œ ë°±ì—”ë“œ ì—°ê²° ê°€ì •)
  baseURL: 'http://localhost:5000',          // ëª¨ë“  ìƒëŒ€ ê²½ë¡œ ìš”ì²­ì€ '/localhost:80'ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë³´ë‚¸ë‹¤. (Vite dev proxyë¡œ ë°±ì—”ë“œ ì—°ê²° ê°€ì •)
  // baseURL: 'http://localhost:8081',          // ëª¨ë“  ìƒëŒ€ ê²½ë¡œ ìš”ì²­ì€ '/localhost:80'ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë³´ë‚¸ë‹¤. (Vite dev proxyë¡œ ë°±ì—”ë“œ ì—°ê²° ê°€ì •)
  withCredentials: true,    // âœ… ë¸Œë¼ìš°ì €ê°€ HttpOnly ì¿ í‚¤(ë¦¬í”„ë ˆì‹œ í† í°)ë¥¼ ìë™ìœ¼ë¡œ ì „ì†¡í•˜ë„ë¡ í—ˆìš©
  timeout: 15000,           // ë„¤íŠ¸ì›Œí¬ ìš”ì²­ íƒ€ì„ì•„ì›ƒ(ms). í•„ìš”ì— ë”°ë¼ ì¡°ì • ê°€ëŠ¥.
});


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 2) ì „ì—­ ìƒíƒœ ë³€ìˆ˜ (ëª¨ë“ˆ ìŠ¤ì½”í”„)
//    - refreshPromise: ì§„í–‰ ì¤‘ì¸ ë¦¬í”„ë ˆì‹œ ìš”ì²­ì„ ê¸°ë¡í•˜ëŠ” "í•˜ë‚˜ì˜" Promise
//                      ë™ì‹œì— ì—¬ëŸ¬ ìš”ì²­ì´ 401ì„ ë§Œë‚˜ë„ ìƒˆë¡œ ë§Œë“¤ì§€ ì•Šê³ 
//                      ëª¨ë‘ê°€ ì´ Promiseë¥¼ await í•˜ë„ë¡ ë§Œë“¤ê¸° ìœ„í•´ ì‚¬ìš©
//    - isRefreshing:   (ì„ íƒ) ë””ë²„ê¹…/ê°€ë…ì„±ì„ ìœ„í•œ ë³´ì¡° í”Œë˜ê·¸
//    - EXCLUDED_URLS:  ì¸í„°ì…‰í„°ê°€ "ìê¸° ìì‹ (/refresh)"ì„ ë‹¤ì‹œ ê±´ë“œë ¤ ë¬´í•œë£¨í”„
//                      ë‚˜ëŠ” ê²½ìš°ë¥¼ ë§‰ê¸° ìœ„í•´, ë¦¬í”„ë ˆì‹œ/ë¡œê·¸ì¸ ë“±ì˜ URLì„ ì œì™¸
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let refreshPromise = null;                 // âœ” ì§„í–‰ ì¤‘ì¸ ë¦¬í”„ë ˆì‹œ ìš”ì²­ì´ ì—†ìœ¼ë©´ null
let isRefreshing = false;                  // âœ” (ì„ íƒ) ë””ë²„ê¹…ìš© í”Œë˜ê·¸
const EXCLUDED_URLS = [                    // âœ” ì¸í„°ì…‰í„° ì œì™¸ ëŒ€ìƒ URLë“¤
  '/member/refresh',                       //    - ì‹¤ì œ ë¦¬í”„ë ˆì‹œ í˜¸ì¶œ ê²½ë¡œ
  // '/auth/login',                           //    - ë¡œê·¸ì¸ ìš”ì²­(í™˜ê²½ì— ë§ê²Œ ì¶”ê°€/ìˆ˜ì •)
];
const refreshUrl = '/member/refresh';


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 3) ìš”ì²­ ì¸í„°ì…‰í„° (request interceptor)
//    - ëª¨ë“  ìš”ì²­ì´ ì„œë²„ë¡œ ë‚˜ê°€ê¸° "ì§ì „"ì— ì‹¤í–‰ëœë‹¤.
//    - Pinia ìŠ¤í† ì–´ì—ì„œ í˜„ì¬ ë³´ê´€ ì¤‘ì¸ access tokenì„ êº¼ë‚´ Authorization í—¤ë”ì— ì‹¤ì–´ì¤€ë‹¤.
//    - ì´ë¯¸ í—¤ë”ê°€ ìˆìœ¼ë©´ ë®ì–´ì“°ì§€ ì•Šê³ , ì—†ì„ ë•Œë§Œ ì„¸íŒ…í•œë‹¤(ì›í•˜ë©´ í•­ìƒ êµì²´í•´ë„ ë¨).
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
api.interceptors.request.use((config) => {
  // ë§¤ ìš”ì²­ë§ˆë‹¤ Pinia ìŠ¤í† ì–´ì—ì„œ ìµœì‹  í† í°ì„ ì½ëŠ”ë‹¤. (ì•±ì´ createPinia() ëœ ë’¤ë¼ë©´ ì•ˆì „)
  // const user = useUserStore();              // í˜„ì¬ í™œì„±í™”ëœ Pinia ì¸ìŠ¤í„´ìŠ¤ì—ì„œ user ìŠ¤í† ì–´ë¥¼ ê°€ì ¸ì˜¨ë‹¤.
  const user = useUserStore();   
  const token = user.token;                 // ìŠ¤í† ì–´ê°€ ë“¤ê³  ìˆëŠ” ì•¡ì„¸ìŠ¤ í† í° ë¬¸ìì—´ì„ ì½ëŠ”ë‹¤.
  console.log(`[${formattedTimeForKor()}] ë°±ì—”ë“œ ìš”ì²­:`,`[${config.method}]`,`${api.defaults.baseURL + config.url}`,config);
  // í† í°ì´ ì¡´ì¬í•˜ë©´ Authorization í—¤ë”ë¥¼ í‘œì¤€ Bearer ìŠ¤í‚´ìœ¼ë¡œ ì„¸íŒ…í•œë‹¤.
  if (token) {
    config.headers = config.headers || {};  // headers ê°ì²´ê°€ ì—†ì„ ìˆ˜ë„ ìˆìœ¼ë¯€ë¡œ ë³´ì¥í•œë‹¤.
    config.headers.Authorization = `Bearer ${token}`; // "Authorization: Bearer <JWT>" í˜•íƒœë¡œ ì‚½ì….
  }

  // (ì„ íƒ) ì—¬ê¸°ì—ì„œ ë§Œë£Œ ì„ë°• ì‹œ ì„ ì œ ë¦¬í”„ë ˆì‹œ ë¡œì§ì„ ë„£ì„ ìˆ˜ë„ ìˆì§€ë§Œ,
  //        ë³´í†µì€ ì‘ë‹µ ì¸í„°ì…‰í„°(401 ì²˜ë¦¬)ì—ì„œ ë¦¬í”„ë ˆì‹œë¥¼ íŠ¸ë¦¬ê±°í•˜ëŠ” í¸ì´ ë‹¨ìˆœ/ì§ê´€ì ì´ë‹¤.
  return config;                            // ìˆ˜ì •ëœ configë¥¼ ë°˜í™˜í•˜ë©´ ì´ ì„¤ì •ì´ ì‹¤ì œ ìš”ì²­ì— ì ìš©ëœë‹¤.
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 4) ì‘ë‹µ ì¸í„°ì…‰í„° (response interceptor)
//    - ì„œë²„ì—ì„œ ì‘ë‹µì´ ëŒì•„ì™”ì„ ë•Œ ì‹¤í–‰ëœë‹¤.
//    - ì •ìƒ ì‘ë‹µì€ ê·¸ëŒ€ë¡œ ë°˜í™˜, ì—ëŸ¬ ì‘ë‹µ(íŠ¹íˆ 401/403)ì€ í† í° ë¦¬í”„ë ˆì‹œë¥¼ ì‹œë„í•œë‹¤.
//    - í•µì‹¬: ë‹¨ í•˜ë‚˜ì˜ refreshPromiseë§Œ ë§Œë“¤ì–´ ëª¨ë‘ê°€ await í•˜ë„ë¡ í•œë‹¤.
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
api.interceptors.response.use(
  // 4-1) ì„±ê³µ ì‘ë‹µì€ ìˆëŠ” ê·¸ëŒ€ë¡œ í†µê³¼
  (response) => response,

  // 4-2) ì—ëŸ¬ ì‘ë‹µ ì²˜ë¦¬(ì£¼ë¡œ 401/403)
  async (error) => {
    // 4-2-1) ì‹¤íŒ¨í•œ "ì› ìš”ì²­"ì˜ ì„¤ì • ê°ì²´ë¥¼ ê°€ì ¸ì˜¨ë‹¤.
    const original = error && error.config; // âœ” ì‹¤íŒ¨ ìš”ì²­ì˜ axios config (ì¬ì‹œë„ì— í•„ìš”)
    const status = error && error.response && error.response.status; // âœ” HTTP ìƒíƒœ ì½”ë“œ
          console.log(`error ê°’: `, error);

    // 4-2-2) ì„¤ì • ê°ì²´ê°€ ì—†ìœ¼ë©´(ì•„ì£¼ íŠ¹ì´ ì¼€ì´ìŠ¤) ë” í•  ìˆ˜ ìˆëŠ” ê²Œ ì—†ìœ¼ë¯€ë¡œ ê·¸ëŒ€ë¡œ ë˜ì§„ë‹¤.
    if (!original) {
      return Promise.reject(error);
    }

    // 4-2-3) ì¸í„°ì…‰í„° ì œì™¸ ëŒ€ìƒ URLì´ë©´(ë¦¬í”„ë ˆì‹œ/ë¡œê·¸ì¸ì´ ì‹¤íŒ¨í•´ì„œ ë˜ ë“¤ì–´ì˜¨ ê²½ìš° ë“±),
    //        ë£¨í”„ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ ê·¸ëŒ€ë¡œ ë˜ì§„ë‹¤.
    const url = original.url || '';
    if (EXCLUDED_URLS.some((u) => url.includes(u))) {
      return Promise.reject(error);
    }

    console.log(`original._retry ê°’ : ` ,original?._retry);
    // 4-2-4) 401 ë˜ëŠ” 403ì„ ë§Œë‚¬ê³ , ì•„ì§ ì´ ìš”ì²­ì— ëŒ€í•´ ì¬ì‹œë„ ë§ˆí¬ë¥¼ ì•ˆ ë‹¬ì•˜ë‹¤ë©´ ì²˜ë¦¬ ì‹œì‘
    if ((status === 401 || status === 403) && !original._retry) {

      const user = useUserStore();
      // console.log('í† í° ê°’::::::', user.token);
      // console.log('í† í° ë§Œë£Œ ìœ ë¬´', isTokenExpired(user.token));

      if(!isTokenExpired(user.token))
      {
        return Promise.reject(error);
      }

      // payload.exp  <-- ì—¬ê¸°ì„œ exp êº¼ë‚¼ ìˆ˜ ìˆìŒ


      // ë¦¬í”„ë˜ì‹œ ìš”ì²­ì´ ì—ëŸ¬ ë‚¬ì„ ê²½ìš° ë¡œê·¸ì•„ì›ƒ ì‹¤í–‰
      // if(original.url === refreshUrl)
      // {
      //     console.log('=============ë¦¬í”„ë˜ì‹œ ì—ëŸ¬ ë‚˜ëŠ”ê³³ íƒ===================')
      //     // console.log('ë¦¬í”„ë˜ì‹œ ì´ìƒ ===========')
      //     // isRefreshing = false;                                  
      //     // refreshPromise = null;   
      //     // toastError('ì´ìƒ ì ‘ê·¼ ê°ì§€',{description: 'ë¹„ì •ìƒ ì ‘ê·¼ì´ ê°‘ì§€ ë˜ì–´ ì¬ ë¡œê·¸ì¸ ì‹œë„ ë¶€íƒ ë“œë¦½ë‹ˆë‹¤.' });
      //     // const user = useUserStore();     
      //     // user.logOut();                       
      //     // await router.push('/')  
      //     // ğŸ”¥ ì—¬ê¸°ì„œ ëë‚´ì•¼ ì•„ë˜ì—ì„œ ë˜ /member/refresh ì•ˆ ê°
      //     return Promise.reject(error);
      // }

      // 4-2-4-1) ë¬´í•œ ë£¨í”„ ë°©ì§€ë¥¼ ìœ„í•œ ì»¤ìŠ¤í…€ í”Œë˜ê·¸
      original._retry = true;

      try {
          // console.log('ë¦¬í”„ë˜ì‹œ ì‹œë„?')
          // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          // (A) í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ë¦¬í”„ë ˆì‹œê°€ ì—†ë‹¤ë©´ "ì§€ê¸ˆ" í•˜ë‚˜ ë§Œë“ ë‹¤.
          //     ìˆìœ¼ë©´ ìƒˆë¡œ ë§Œë“¤ì§€ ì•Šê³  ê·¸ Promiseë¥¼ ê·¸ëŒ€ë¡œ ê¸°ë‹¤ë¦°ë‹¤.
          //     â†’ ì´ë ‡ê²Œ í•˜ë©´ ë™ì‹œ ë‹¤ë°œì ì¸ 401ì—ë„ ë¦¬í”„ë ˆì‹œê°€ 1ë²ˆë§Œ ì¼ì–´ë‚œë‹¤.
          // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          // console.log(`original ê°’ : ` ,original);
          // console.log(`refreshPromise ê°’: `, refreshPromise);
          // console.log(`isRefreshing ê°’: `, isRefreshing);
          if (!refreshPromise) {
            isRefreshing = true;                                       // âœ” (ì„ íƒ) í”Œë˜ê·¸ on

            // 4-2-4-2) ìƒˆ ë¦¬í”„ë ˆì‹œ Promise ìƒì„±
            refreshPromise = (async () => {
              // 4-2-4-2-1) /refresh í˜¸ì¶œ: withCredentialsë¡œ HttpOnly ì¿ í‚¤ ìë™ ì „ì†¡
              const refreshRes = await api.post(
                refreshUrl,                                            // âœ” baseURL('/member') + '/refresh' = '/member/refresh'
                {},                                                    // âœ” ë³´í†µ ë°”ë””ëŠ” ë¹„ì›€ (ì¿ í‚¤ ê¸°ì¤€ ì‹ë³„)
                {
                  withCredentials: true,                               // âœ” ì¿ í‚¤ ì „ì†¡ í•„ìˆ˜
                  headers: {
                    // (ì„ íƒ) ì„œë²„ê°€ UA/ë””ë°”ì´ìŠ¤ ë°”ì¸ë”© ê²€ì¦ì„ í•œë‹¤ë©´ ê°„ë‹¨í•œ íŒíŠ¸ë¡œ ë””ë°”ì´ìŠ¤ ì§€ë¬¸ì„ ë³´ë‚¼ ìˆ˜ ìˆë‹¤.
                    'X-Device-Fp': sessionStorage.getItem('device_fp') || '',
                  },
                }
              );

              // 4-2-4-2-2) ì„œë²„ê°€ ìƒˆ ì•¡ì„¸ìŠ¤ í† í°ì„ JSON ë°”ë””ë¡œ ë‚´ë ¤ì¤€ë‹¤ê³  ê°€ì •
              const newAccessToken = refreshRes && refreshRes.data && refreshRes.data.accessToken;

              // 4-2-4-2-3) í† í°ì´ ì—†ë‹¤ë©´ ì—ëŸ¬ë¡œ ê°„ì£¼
              if (!newAccessToken) {
                throw new Error('No accessToken in refresh response');
              }

              // 4-2-4-2-4) Pinia ìŠ¤í† ì–´ì— ìƒˆ í† í° ë°˜ì˜ (ìš”ì²­ ì¸í„°ì…‰í„°ê°€ ì´í›„ë¶€í„° ìë™ ë¶€ì°©)
              const user = useUserStore();                             // âœ” ìŠ¤í† ì–´ ì ‘ê·¼
              user.setToken(newAccessToken);                           // âœ” í† í° ê°±ì‹ (Pinia ìƒíƒœ ì—…ë°ì´íŠ¸)
              info('í† í° ì¬ ë°œê¸‰',{description: 'ì—‘ì„¸ìŠ¤ í† í°ì´ ì¬ ë°œê¸‰ ë˜ì—ˆìŠµë‹ˆë‹¤.' });
              // 4-2-4-2-5) ì´ Promiseì˜ ê²°ê³¼ê°’ìœ¼ë¡œ ìƒˆ í† í°ì„ ë°˜í™˜ (ë™ì‹œì— ê¸°ë‹¤ë¦¬ëŠ” ìš”ì²­ë“¤ì´ ì´ ê°’ì„ ë°›ëŠ”ë‹¤)
              return newAccessToken;
          })()
            .catch(async(e) => {
              console.log('apiì—ì„œ catchë¹ ì§ :' ,e);
              // 4-2-4-3) ë¦¬í”„ë ˆì‹œ ìì²´ê°€ ì‹¤íŒ¨í•œ ê²½ìš°: ë” ì´ìƒì˜ ìë™ ë³µêµ¬ê°€ ë¶ˆê°€
              console.log('apiì—ì„œ catchë¹ ì§2 ');
              const user = useUserStore();                           // âœ” ìŠ¤í† ì–´ ì ‘ê·¼
              console.log('apiì—ì„œ catchë¹ ì§3 ');
              user.logOut();                                         // âœ” ë¡œê·¸ì¸ ìƒíƒœ ì´ˆê¸°í™”/ì„¸ì…˜ ì •ë¦¬
              console.log('apiì—ì„œ catchë¹ ì§4');
              toastError('ì´ìƒ ì ‘ê·¼ ê°ì§€',{description: 'ë¹„ì •ìƒ ì ‘ê·¼ì´ ê°‘ì§€ ë˜ì–´ ì¬ ë¡œê·¸ì¸ ì‹œë„ ë¶€íƒ ë“œë¦½ë‹ˆë‹¤.' });
              console.log('apiì—ì„œ catchë¹ ì§5');
              
                 
              await router.push('/') 
              throw e;                                           // âœ” ìƒìœ„ë¡œ ì—ëŸ¬ ì „íŒŒ
            })
            .finally(() => {
              isRefreshing = false;                                  // âœ” (ì„ íƒ) í”Œë˜ê·¸ off
              refreshPromise = null;                                 // âœ” ë‹¤ìŒ 401ì„ ìœ„í•´ promise ìŠ¬ë¡¯ ë¹„ìš°ê¸°
            });
          }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // (B) ì—¬ê¸°ì„œëŠ” "ì´ë¯¸ ìˆê±°ë‚˜ ë°©ê¸ˆ ë§Œë“ " ê³µìš© refreshPromiseë¥¼ ê¸°ë‹¤ë¦°ë‹¤.
        //     ëª¨ë“  ë™ì‹œ 401 ìš”ì²­ì´ ê°™ì€ Promiseë¥¼ await í•˜ë¯€ë¡œ ë¦¬í”„ë ˆì‹œê°€ 1íšŒë§Œ ìˆ˜í–‰ëœë‹¤.
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const token = await refreshPromise;                          // âœ” ìƒˆ í† í° ìˆ˜ì‹ 

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // (C) ìƒˆ í† í°ìœ¼ë¡œ "ì› ìš”ì²­"ì„ ì¬ì‹œë„
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        original.headers = original.headers || {};                   // âœ” í—¤ë” ê°ì²´ ë³´ì¥
        original.headers.Authorization = `Bearer ${token}`;          // âœ” Authorization êµì²´
        return api(original);                                        // âœ” ë™ì¼ ì¸ìŠ¤í„´ìŠ¤ë¡œ ì¬ì‹œë„í•˜ì—¬ ê²°ê³¼ ë°˜í™˜
      } catch (e) {
        // 4-2-4-5) ë¦¬í”„ë ˆì‹œ ì‹¤íŒ¨: ìƒìœ„ë¡œ ì—ëŸ¬ ì „íŒŒ(ë¼ìš°í„°ì—ì„œ /loginìœ¼ë¡œ ë³´ë‚´ëŠ” ë“± ì²˜ë¦¬)
        return Promise.reject(e);
      }
    }

    // 4-2-5) 401/403ì´ ì•„ë‹ˆê±°ë‚˜, ì´ë¯¸ ì¬ì‹œë„í•œ ìš”ì²­ì´ë¼ë©´ ê·¸ ì™¸ ì—ëŸ¬ë¥¼ ê·¸ëŒ€ë¡œ ì „íŒŒ
    return Promise.reject(error);
  }
);



// ------------------------------------------------------------
// 4) ë‹¤ë¥¸ íŒŒì¼ì—ì„œ import í•´ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ export í•œë‹¤.
//    ì´ ì¸ìŠ¤í„´ìŠ¤ë§Œ ì“°ë©´ í”„ë¡ì‹œ/ì¿ í‚¤/í† í°/ì¬ì‹œë„ ê·œì¹™ì´ ìë™ìœ¼ë¡œ ì ìš©ëœë‹¤.
// ------------------------------------------------------------
export default api;