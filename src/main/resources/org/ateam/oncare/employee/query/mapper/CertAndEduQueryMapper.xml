<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.ateam.oncare.employee.query.mapper.CertAndEduQueryMapper">

    <resultMap id="CertificateViewMap" type="org.ateam.oncare.employee.query.dto.CertificateViewDTO">
        <id property="id" column="cwc_id"/>
        <result property="employeeId" column="employee_id"/>
        <result property="employeeName" column="employee_name"/>

        <result property="certificateName" column="certificate_name"/>
        <result property="organization" column="organization"/>
        <result property="licenseNo" column="license_no"/>
        <result property="issueDate" column="issue_date"/>
        <result property="expireDate" column="expire_date"/>
        <result property="status" column="status"/>
    </resultMap>

    <resultMap id="EducationMap" type="org.ateam.oncare.employee.query.dto.EducationDTO">
        <id property="id" column="education_id"/>           <result property="eduName" column="edu_name"/>
        <result property="institution" column="institution"/>
        <result property="eduDate" column="edu_date"/>
        <result property="nextEduDate" column="next_edu_date"/>
        <result property="isOverdue" column="is_overdue"/>
        <result property="status" column="status"/>
        <result property="relatedLicenseName" column="related_license_name"/>
    </resultMap>

    <resultMap id="CertificateMasterMap" type="org.ateam.oncare.employee.query.dto.CertificateMasterDTO">
        <id property="id" column="id"/>
        <result property="certificateName" column="certificate_name"/>
        <result property="organization" column="organization"/>
        <result property="eduCycleYears" column="edu_cycle_years"/>
    </resultMap>

    <select id="selectAllCertificates" resultMap="CertificateMasterMap">
        SELECT
            id,
            certificate_name,
            organization,
            edu_cycle_years
        FROM certificate
        ORDER BY certificate_name ASC
    </select>


    <select id="selectCertificatesByEmployeeId" resultMap="CertificateViewMap">
        SELECT
        cwc.id AS cwc_id,
        e.id AS employee_id,
        e.name AS employee_name,  -- ★ [추가] 직원 테이블의 이름 조회
        m.certificate_name,
        m.organization,
        cwc.license_no,
        cwc.issue_date,
        cwc.expire_date,
        cwc.`status`
        FROM care_worker_certificate cwc
        JOIN certificate m ON cwc.certificate_id = m.id
        JOIN care_worker cw ON cwc.care_worker_id = cw.id
        JOIN employee e ON cw.employee_id = e.id
        WHERE cw.employee_id = #{employeeId}
        ORDER BY cwc.issue_date DESC
    </select>

    <select id="selectEducationsByCertId" resultMap="EducationMap">
        SELECT
        e.id               AS education_id,      e.edu_name,
        e.institution,
        e.edu_date,
        e.next_edu_date,
        e.is_overdue,
        e.`status`,
        m.certificate_name AS related_license_name
        FROM education e
        JOIN care_worker_certificate cwc ON e.care_worker_certificate_id = cwc.id
        JOIN certificate m ON cwc.certificate_id = m.id
        WHERE e.care_worker_certificate_id = #{careWorkerCertId}
        ORDER BY e.edu_date DESC
    </select>

    <select id="selectCertificates" resultMap="CertificateViewMap">
        SELECT
            cwc.id AS cwc_id,
            e.id AS employee_id,
            e.name AS employee_name,
            m.certificate_name,
            m.organization,
            cwc.license_no,
            cwc.issue_date,
            cwc.expire_date,
            cwc.`status`
        FROM care_worker_certificate cwc
        JOIN certificate m ON cwc.certificate_id = m.id
        JOIN care_worker cw ON cwc.care_worker_id = cw.id
        JOIN employee e ON cw.employee_id = e.id
        <where>
            <if test="statusCode != null">
                AND cwc.`status` = #{statusCode}
            </if>
        </where>

        ORDER BY cwc.issue_date DESC
    </select>

    <!-- 특정 자격증(Master ID)을 보유한 직원 목록 조회 -->
    <select id="selectCertificatesByMasterId" resultMap="CertificateViewMap">
        SELECT
            cwc.id AS cwc_id,
            e.id AS employee_id,
            e.name AS employee_name,
            m.certificate_name,
            m.organization,
            cwc.license_no,
            cwc.issue_date,
            cwc.expire_date,
            cwc.`status`
        FROM care_worker_certificate cwc
        JOIN certificate m ON cwc.certificate_id = m.id
        JOIN care_worker cw ON cwc.care_worker_id = cw.id
        JOIN employee e ON cw.employee_id = e.id
        WHERE m.id = #{masterId}
        <!-- 필요 시 상태 조건 추가 가능 -->
        <!-- AND cwc.status = 2 -->
        ORDER BY e.name ASC
    </select>

    <select id="selectEducationAlerts" resultType="org.ateam.oncare.employee.query.dto.EducationAlertDTO">
        SELECT
            e.id AS employeeId,
            e.name AS name,
            max_edu.next_edu_date AS nextEduDate,
            DATEDIFF(max_edu.next_edu_date, CURDATE()) AS dDay,
            CASE
                WHEN max_edu.next_edu_date &lt; CURDATE() THEN 'OVERDUE'
                ELSE 'WARNING'
            END AS status
        FROM care_worker_certificate cwc
        JOIN (
            SELECT care_worker_certificate_id, MAX(next_edu_date) AS next_edu_date
            FROM education
            GROUP BY care_worker_certificate_id
        ) max_edu ON cwc.id = max_edu.care_worker_certificate_id
        JOIN care_worker cw ON cwc.care_worker_id = cw.id
        JOIN employee e ON cw.employee_id = e.id
        WHERE max_edu.next_edu_date &lt;= #{thresholdDate}
    </select>
</mapper>