<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.ateam.oncare.careworker.query.mapper.BasicEvaluationMapper">

    <!-- 기초평가 목록 조회 (요양보호사별, matching 기준 현재 배정 중인 수급자만) -->
    <select id="selectBasicEvaluationList" resultType="org.ateam.oncare.careworker.query.dto.BasicEvaluationListDto">
        SELECT
            be.eval_id AS evalId,
            be.eval_type AS evalType,
            CASE be.eval_type
                WHEN 'FALL' THEN '낙상위험도 평가'
                WHEN 'BEDSORE' THEN '욕창위험도 평가'
                WHEN 'COGNITIVE' THEN '인지기능 평가'
                WHEN 'NEEDS' THEN '욕구사정 평가'
                ELSE be.eval_type
            END AS evalTypeName,
            be.eval_date AS evalDate,
            be.beneficiary_id AS beneficiaryId,
            b.name AS beneficiaryName,
            COALESCE(mcl.level, '등급없음') AS careLevel,
            CASE
                WHEN be.is_draft = TRUE THEN '임시저장'
                WHEN be.eval_type = 'FALL' THEN COALESCE(
                    JSON_UNQUOTE(JSON_EXTRACT(be.eval_data, '$.result.grade')),
                    JSON_UNQUOTE(JSON_EXTRACT(be.eval_data, '$.grade'))
                )
                WHEN be.eval_type = 'BEDSORE' THEN COALESCE(
                    JSON_UNQUOTE(JSON_EXTRACT(be.eval_data, '$.result.grade')),
                    JSON_UNQUOTE(JSON_EXTRACT(be.eval_data, '$.grade'))
                )
                WHEN be.eval_type = 'COGNITIVE' THEN COALESCE(
                    JSON_UNQUOTE(JSON_EXTRACT(be.eval_data, '$.result.grade')),
                    JSON_UNQUOTE(JSON_EXTRACT(be.eval_data, '$.interpretation.result'))
                )
                WHEN be.eval_type = 'NEEDS' THEN COALESCE(
                    JSON_UNQUOTE(JSON_EXTRACT(be.eval_data, '$.result.grade')),
                    '평가완료'
                )
                ELSE COALESCE(
                    JSON_UNQUOTE(JSON_EXTRACT(be.eval_data, '$.result.grade')),
                    JSON_UNQUOTE(JSON_EXTRACT(be.eval_data, '$.grade'))
                )
            END AS resultGrade,
            CASE be.eval_type
                WHEN 'FALL' THEN COALESCE(
                    JSON_EXTRACT(be.eval_data, '$.result.total_score'),
                    JSON_EXTRACT(be.eval_data, '$.total_score')
                )
                WHEN 'NEEDS' THEN NULL
                ELSE COALESCE(
                    JSON_EXTRACT(be.eval_data, '$.result.total_score'),
                    JSON_EXTRACT(be.eval_data, '$.total_score')
                )
            END AS totalScore,
            be.special_note AS specialNote
        FROM basic_evaluations be
                 INNER JOIN care_worker cw ON be.care_worker_id = cw.id
                 LEFT JOIN beneficiary b ON be.beneficiary_id = b.id
                 LEFT JOIN (
                     SELECT beneficiary_id, id
                     FROM beneficiary_care_level bcl1
                     WHERE start_date = (
                         SELECT MAX(start_date)
                         FROM beneficiary_care_level bcl2
                         WHERE bcl2.beneficiary_id = bcl1.beneficiary_id
                     )
                 ) bcl ON b.id = bcl.beneficiary_id
                 LEFT JOIN beneficiary_count bc ON bcl.id = bc.beneficiary_care_level_id
                 LEFT JOIN m_care_level mcl ON bc.m_care_level_id = mcl.id
                 JOIN matching m ON m.care_worker_id = cw.id AND m.beneficiary_id = be.beneficiary_id AND m.status = 'Y'
        WHERE cw.employee_id = #{caregiverId}
        ORDER BY be.eval_date DESC, be.created_at DESC
    </select>

    <!-- 기초평가 목록 조회 (수급자별) -->
    <select id="selectBasicEvaluationListByBeneficiary" resultType="org.ateam.oncare.careworker.query.dto.BasicEvaluationListDto">
        SELECT
            be.eval_id AS evalId,
            be.eval_type AS evalType,
            CASE be.eval_type
                WHEN 'FALL' THEN '낙상위험도 평가'
                WHEN 'BEDSORE' THEN '욕창위험도 평가'
                WHEN 'COGNITIVE' THEN '인지기능 평가'
                WHEN 'NEEDS' THEN '욕구사정 평가'
                ELSE be.eval_type
            END AS evalTypeName,
            be.eval_date AS evalDate,
            be.beneficiary_id AS beneficiaryId,
            b.name AS beneficiaryName,
            COALESCE(mcl.level, '등급없음') AS careLevel,
            CASE
                WHEN be.is_draft = TRUE THEN '임시저장'
                WHEN be.eval_type = 'FALL' THEN COALESCE(
                    JSON_UNQUOTE(JSON_EXTRACT(be.eval_data, '$.result.grade')),
                    JSON_UNQUOTE(JSON_EXTRACT(be.eval_data, '$.grade'))
                )
                WHEN be.eval_type = 'BEDSORE' THEN COALESCE(
                    JSON_UNQUOTE(JSON_EXTRACT(be.eval_data, '$.result.grade')),
                    JSON_UNQUOTE(JSON_EXTRACT(be.eval_data, '$.grade'))
                )
                WHEN be.eval_type = 'COGNITIVE' THEN COALESCE(
                    JSON_UNQUOTE(JSON_EXTRACT(be.eval_data, '$.result.grade')),
                    JSON_UNQUOTE(JSON_EXTRACT(be.eval_data, '$.interpretation.result'))
                ) <!-- 인지기능 평가 결과 조회 -->
                WHEN be.eval_type = 'NEEDS' THEN COALESCE(
                    JSON_UNQUOTE(JSON_EXTRACT(be.eval_data, '$.result.grade')),
                    '평가완료'
                )
                ELSE COALESCE(
                    JSON_UNQUOTE(JSON_EXTRACT(be.eval_data, '$.result.grade')),
                    JSON_UNQUOTE(JSON_EXTRACT(be.eval_data, '$.grade'))
                )
            END AS resultGrade,
            CASE be.eval_type
                WHEN 'FALL' THEN COALESCE(
                    JSON_EXTRACT(be.eval_data, '$.result.total_score'),
                    JSON_EXTRACT(be.eval_data, '$.total_score')
                )
                WHEN 'NEEDS' THEN NULL
                ELSE COALESCE(
                    JSON_EXTRACT(be.eval_data, '$.result.total_score'),
                    JSON_EXTRACT(be.eval_data, '$.total_score')
                )
            END AS totalScore,
            be.special_note AS specialNote
        FROM basic_evaluations be
                 LEFT JOIN beneficiary b ON be.beneficiary_id = b.id
                 LEFT JOIN (
                     SELECT beneficiary_id, id
                     FROM beneficiary_care_level bcl1
                     WHERE start_date = (
                         SELECT MAX(start_date)
                         FROM beneficiary_care_level bcl2
                         WHERE bcl2.beneficiary_id = bcl1.beneficiary_id
                     )
                 ) bcl ON b.id = bcl.beneficiary_id
                 LEFT JOIN beneficiary_count bc ON bcl.id = bc.beneficiary_care_level_id
                 LEFT JOIN m_care_level mcl ON bc.m_care_level_id = mcl.id
        WHERE be.beneficiary_id = #{beneficiaryId}
        ORDER BY be.eval_date DESC, be.created_at DESC
    </select>

    <!-- 기초평가 목록 조회 (평가 유형별, matching 기준 현재 배정 중인 수급자만) -->
    <select id="selectBasicEvaluationListByType" resultType="org.ateam.oncare.careworker.query.dto.BasicEvaluationListDto">
        SELECT
            be.eval_id AS evalId,
            be.eval_type AS evalType,
            CASE be.eval_type
                WHEN 'FALL' THEN '낙상위험도 평가'
                WHEN 'BEDSORE' THEN '욕창위험도 평가'
                WHEN 'COGNITIVE' THEN '인지기능 평가'
                WHEN 'NEEDS' THEN '욕구사정 평가'
                ELSE be.eval_type
            END AS evalTypeName,
            be.eval_date AS evalDate,
            be.beneficiary_id AS beneficiaryId,
            b.name AS beneficiaryName,
            COALESCE(mcl.level, '등급없음') AS careLevel,
            CASE
                WHEN be.is_draft = TRUE THEN '임시저장'
                WHEN be.eval_type = 'FALL' THEN COALESCE(
                    JSON_UNQUOTE(JSON_EXTRACT(be.eval_data, '$.result.grade')),
                    JSON_UNQUOTE(JSON_EXTRACT(be.eval_data, '$.grade'))
                )
                WHEN be.eval_type = 'BEDSORE' THEN COALESCE(
                    JSON_UNQUOTE(JSON_EXTRACT(be.eval_data, '$.result.grade')),
                    JSON_UNQUOTE(JSON_EXTRACT(be.eval_data, '$.grade'))
                )
                WHEN be.eval_type = 'COGNITIVE' THEN COALESCE(
                    JSON_UNQUOTE(JSON_EXTRACT(be.eval_data, '$.result.grade')),
                    JSON_UNQUOTE(JSON_EXTRACT(be.eval_data, '$.interpretation.result'))
                )
                WHEN be.eval_type = 'NEEDS' THEN COALESCE(
                    JSON_UNQUOTE(JSON_EXTRACT(be.eval_data, '$.result.grade')),
                    '평가완료'
                )
                ELSE COALESCE(
                    JSON_UNQUOTE(JSON_EXTRACT(be.eval_data, '$.result.grade')),
                    JSON_UNQUOTE(JSON_EXTRACT(be.eval_data, '$.grade'))
                )
            END AS resultGrade,
            CASE be.eval_type
                WHEN 'FALL' THEN COALESCE(
                    JSON_EXTRACT(be.eval_data, '$.result.total_score'),
                    JSON_EXTRACT(be.eval_data, '$.total_score')
                )
                WHEN 'NEEDS' THEN NULL
                ELSE COALESCE(
                    JSON_EXTRACT(be.eval_data, '$.result.total_score'),
                    JSON_EXTRACT(be.eval_data, '$.total_score')
                )
            END AS totalScore,
            be.special_note AS specialNote
        FROM basic_evaluations be
                 INNER JOIN care_worker cw ON be.care_worker_id = cw.id
                 LEFT JOIN beneficiary b ON be.beneficiary_id = b.id
                 LEFT JOIN (
                     SELECT beneficiary_id, id
                     FROM beneficiary_care_level bcl1
                     WHERE start_date = (
                         SELECT MAX(start_date)
                         FROM beneficiary_care_level bcl2
                         WHERE bcl2.beneficiary_id = bcl1.beneficiary_id
                     )
                 ) bcl ON b.id = bcl.beneficiary_id
                 LEFT JOIN beneficiary_count bc ON bcl.id = bc.beneficiary_care_level_id
                 LEFT JOIN m_care_level mcl ON bc.m_care_level_id = mcl.id
                 JOIN matching m ON m.care_worker_id = cw.id AND m.beneficiary_id = be.beneficiary_id AND m.status = 'Y'
        WHERE cw.employee_id = #{caregiverId}
          AND be.eval_type = #{evalType}
          <if test="year != null">
          AND YEAR(be.eval_date) = #{year}
          </if>
        ORDER BY be.eval_date DESC, be.created_at DESC
    </select>

    <!-- 기초평가 목록 조회 (수급자별 + 평가 유형별) -->
    <select id="selectBasicEvaluationListByBeneficiaryAndType" resultType="org.ateam.oncare.careworker.query.dto.BasicEvaluationListDto">
        SELECT
            be.eval_id AS evalId,
            be.eval_type AS evalType,
            CASE be.eval_type
                WHEN 'FALL' THEN '낙상위험도 평가'
                WHEN 'BEDSORE' THEN '욕창위험도 평가'
                WHEN 'COGNITIVE' THEN '인지기능 평가'
                WHEN 'NEEDS' THEN '욕구사정 평가'
                ELSE be.eval_type
            END AS evalTypeName,
            be.eval_date AS evalDate,
            be.beneficiary_id AS beneficiaryId,
            b.name AS beneficiaryName,
            COALESCE(mcl.level, '등급없음') AS careLevel,
            CASE
                WHEN be.is_draft = TRUE THEN '임시저장'
                WHEN be.eval_type = 'FALL' THEN COALESCE(
                    JSON_UNQUOTE(JSON_EXTRACT(be.eval_data, '$.result.grade')),
                    JSON_UNQUOTE(JSON_EXTRACT(be.eval_data, '$.grade'))
                )
                WHEN be.eval_type = 'BEDSORE' THEN COALESCE(
                    JSON_UNQUOTE(JSON_EXTRACT(be.eval_data, '$.result.grade')),
                    JSON_UNQUOTE(JSON_EXTRACT(be.eval_data, '$.grade'))
                )
                WHEN be.eval_type = 'COGNITIVE' THEN COALESCE(
                    JSON_UNQUOTE(JSON_EXTRACT(be.eval_data, '$.result.grade')),
                    JSON_UNQUOTE(JSON_EXTRACT(be.eval_data, '$.interpretation.result'))
                )
                WHEN be.eval_type = 'NEEDS' THEN COALESCE(
                    JSON_UNQUOTE(JSON_EXTRACT(be.eval_data, '$.result.grade')),
                    '평가완료'
                )
                ELSE COALESCE(
                    JSON_UNQUOTE(JSON_EXTRACT(be.eval_data, '$.result.grade')),
                    JSON_UNQUOTE(JSON_EXTRACT(be.eval_data, '$.grade'))
                )
            END AS resultGrade,
            CASE be.eval_type
                WHEN 'FALL' THEN COALESCE(
                    JSON_EXTRACT(be.eval_data, '$.result.total_score'),
                    JSON_EXTRACT(be.eval_data, '$.total_score')
                )
                WHEN 'NEEDS' THEN NULL
                ELSE COALESCE(
                    JSON_EXTRACT(be.eval_data, '$.result.total_score'),
                    JSON_EXTRACT(be.eval_data, '$.total_score')
                )
            END AS totalScore,
            be.special_note AS specialNote
        FROM basic_evaluations be
                 LEFT JOIN beneficiary b ON be.beneficiary_id = b.id
                 LEFT JOIN (
                     SELECT beneficiary_id, id
                     FROM beneficiary_care_level bcl1
                     WHERE start_date = (
                         SELECT MAX(start_date)
                         FROM beneficiary_care_level bcl2
                         WHERE bcl2.beneficiary_id = bcl1.beneficiary_id
                     )
                 ) bcl ON b.id = bcl.beneficiary_id
                 LEFT JOIN beneficiary_count bc ON bcl.id = bc.beneficiary_care_level_id
                 LEFT JOIN m_care_level mcl ON bc.m_care_level_id = mcl.id
        WHERE be.beneficiary_id = #{beneficiaryId}
          AND be.eval_type = #{evalType}
          <if test="year != null">
          AND YEAR(be.eval_date) = #{year}
          </if>
        ORDER BY be.eval_date DESC, be.created_at DESC
    </select>

    <!-- 기초평가 상세 조회 -->
    <select id="selectBasicEvaluationDetail" resultType="org.ateam.oncare.careworker.query.dto.BasicEvaluationDetailDto">
        SELECT
            be.eval_id AS evalId,
            be.eval_type AS evalType,
            CASE be.eval_type
                WHEN 'FALL' THEN '낙상위험도 평가'
                WHEN 'BEDSORE' THEN '욕창위험도 평가'
                WHEN 'COGNITIVE' THEN '인지기능 평가'
                WHEN 'NEEDS' THEN '욕구사정 평가'
                ELSE be.eval_type
            END AS evalTypeName,
            be.template_id AS templateId,
            et.name AS templateName,
            et.version AS templateVersion,
            be.eval_date AS evalDate,
            be.created_at AS createdAt,
            be.beneficiary_id AS beneficiaryId,
            b.name AS beneficiaryName,
            b.address AS beneficiaryAddress,
            COALESCE(mcl.level, '등급없음') AS careLevel,
            be.eval_data AS evalData,
            be.special_note AS specialNote,
            be.is_draft AS isDraft
        FROM basic_evaluations be
                 LEFT JOIN eval_templates et ON be.template_id = et.template_id
                 LEFT JOIN beneficiary b ON be.beneficiary_id = b.id
                 LEFT JOIN (
                     SELECT beneficiary_id, id
                     FROM beneficiary_care_level bcl1
                     WHERE start_date = (
                         SELECT MAX(start_date)
                         FROM beneficiary_care_level bcl2
                         WHERE bcl2.beneficiary_id = bcl1.beneficiary_id
                     )
                 ) bcl ON b.id = bcl.beneficiary_id
                 LEFT JOIN beneficiary_count bc ON bcl.id = bc.beneficiary_care_level_id
                 LEFT JOIN m_care_level mcl ON bc.m_care_level_id = mcl.id
        WHERE be.eval_id = #{evalId}
    </select>

    <!-- 기초평가 상세 조회 (평가 유형 검증 포함) -->
    <select id="selectBasicEvaluationDetailByType" resultType="org.ateam.oncare.careworker.query.dto.BasicEvaluationDetailDto">
        SELECT
            be.eval_id AS evalId,
            be.eval_type AS evalType,
            CASE be.eval_type
                WHEN 'FALL' THEN '낙상위험도 평가'
                WHEN 'BEDSORE' THEN '욕창위험도 평가'
                WHEN 'COGNITIVE' THEN '인지기능 평가'
                WHEN 'NEEDS' THEN '욕구사정 평가'
                ELSE be.eval_type
            END AS evalTypeName,
            be.template_id AS templateId,
            et.name AS templateName,
            et.version AS templateVersion,
            be.eval_date AS evalDate,
            be.created_at AS createdAt,
            be.beneficiary_id AS beneficiaryId,
            b.name AS beneficiaryName,
            b.address AS beneficiaryAddress,
            COALESCE(mcl.level, '등급없음') AS careLevel,
            be.eval_data AS evalData,
            be.special_note AS specialNote,
            be.is_draft AS isDraft
        FROM basic_evaluations be
                 LEFT JOIN eval_templates et ON be.template_id = et.template_id
                 LEFT JOIN beneficiary b ON be.beneficiary_id = b.id
                 LEFT JOIN (
                     SELECT beneficiary_id, id
                     FROM beneficiary_care_level bcl1
                     WHERE start_date = (
                         SELECT MAX(start_date)
                         FROM beneficiary_care_level bcl2
                         WHERE bcl2.beneficiary_id = bcl1.beneficiary_id
                     )
                 ) bcl ON b.id = bcl.beneficiary_id
                 LEFT JOIN beneficiary_count bc ON bcl.id = bc.beneficiary_care_level_id
                 LEFT JOIN m_care_level mcl ON bc.m_care_level_id = mcl.id
        WHERE be.eval_id = #{evalId}
          AND be.eval_type = #{evalType}
    </select>

</mapper>
