<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.ateam.oncare.careworker.query.mapper.CareLogMapper">

    <!-- 요양일지 목록 조회 (요양보호사별) -->
    <select id="selectCareLogList" resultType="org.ateam.oncare.careworker.query.dto.CareLogListDto">
        SELECT
            cl.log_id AS logId,
            cl.service_date AS serviceDate,
            cl.start_time AS startTime,
            cl.end_time AS endTime,
            cl.service_type AS serviceType,
            cl.beneficiary_id AS beneficiaryId,
            b.name AS beneficiaryName,
            COALESCE(mcl.level, '등급없음') AS careLevel
        FROM care_logs cl
                 LEFT JOIN beneficiary b ON cl.beneficiary_id = b.id
                 LEFT JOIN (
                     SELECT beneficiary_id, id
                     FROM beneficiary_care_level bcl1
                     WHERE start_date = (
                         SELECT MAX(start_date)
                         FROM beneficiary_care_level bcl2
                         WHERE bcl2.beneficiary_id = bcl1.beneficiary_id
                     )
                 ) bcl ON b.id = bcl.beneficiary_id
                 LEFT JOIN beneficiary_count bc ON bcl.id = bc.beneficiary_care_level_id
                 LEFT JOIN m_care_level mcl ON bc.m_care_level_id = mcl.id
        WHERE cl.care_worker_id = #{caregiverId}
          AND cl.is_deleted = FALSE
        ORDER BY cl.service_date DESC, cl.created_at DESC
    </select>

    <!-- 요양일지 목록 조회 (수급자별) -->
    <select id="selectCareLogListByBeneficiary" resultType="org.ateam.oncare.careworker.query.dto.CareLogListDto">
        SELECT
            cl.log_id AS logId,
            cl.service_date AS serviceDate,
            cl.start_time AS startTime,
            cl.end_time AS endTime,
            cl.service_type AS serviceType,
            cl.beneficiary_id AS beneficiaryId,
            b.name AS beneficiaryName,
            COALESCE(mcl.level, '등급없음') AS careLevel
        FROM care_logs cl
                 LEFT JOIN beneficiary b ON cl.beneficiary_id = b.id
                 LEFT JOIN (
                     SELECT beneficiary_id, id
                     FROM beneficiary_care_level bcl1
                     WHERE start_date = (
                         SELECT MAX(start_date)
                         FROM beneficiary_care_level bcl2
                         WHERE bcl2.beneficiary_id = bcl1.beneficiary_id
                     )
                 ) bcl ON b.id = bcl.beneficiary_id
                 LEFT JOIN beneficiary_count bc ON bcl.id = bc.beneficiary_care_level_id
                 LEFT JOIN m_care_level mcl ON bc.m_care_level_id = mcl.id
        WHERE cl.beneficiary_id = #{beneficiaryId}
          AND cl.is_deleted = FALSE
        ORDER BY cl.service_date DESC, cl.created_at DESC
    </select>

    <!-- 요양일지 상세 조회 -->
    <select id="selectCareLogDetail" resultType="org.ateam.oncare.careworker.query.dto.CareLogDetailDto">
        SELECT
            cl.log_id AS logId,
            cl.vs_id AS vsId,
            cl.service_date AS serviceDate,
            cl.start_time AS startTime,
            cl.end_time AS endTime,
            cl.service_type AS serviceType,
            cl.created_at AS createdAt,
            cl.updated_at AS updatedAt,
            cl.beneficiary_id AS beneficiaryId,
            b.name AS beneficiaryName,
            b.address AS beneficiaryAddress,
            COALESCE(mcl.level, '등급없음') AS careLevel,
            cl.is_breakfast AS isBreakfast,
            cl.is_lunch AS isLunch,
            cl.is_dinner AS isDinner,
            cl.is_snack AS isSnack,
            cl.diaper_count AS diaperCount,
            cl.toilet_count AS toiletCount,
            cl.is_portable_toilet AS isPortableToilet,
            cl.is_urine AS isUrine,
            cl.is_stool AS isStool,
            cl.stool_normal AS stoolNormal,
            cl.stool_diarrhea AS stoolDiarrhea,
            cl.stool_constipation AS stoolConstipation,
            cl.is_excretion_mistake AS isExcretionMistake,
            cl.is_face_wash AS isFaceWash,
            cl.is_oral_care AS isOralCare,
            cl.is_hair_wash AS isHairWash,
            cl.is_body_wash AS isBodyWash,
            cl.is_change_clothes AS isChangeClothes,
            cl.is_meal_prep AS isMealPrep,
            cl.is_bed_care AS isBedCare,
            cl.is_position_change AS isPositionChange,
            cl.is_get_up_help AS isGetUpHelp,
            cl.is_indoor_move AS isIndoorMove,
            cl.is_walk_help AS isWalkHelp,
            cl.is_emotional_talk AS isEmotionalTalk,
            cl.is_communication AS isCommunication,
            cl.is_counseling AS isCounseling,
            cl.is_cognitive_care AS isCognitiveCare,
            cl.is_behavior_care AS isBehaviorCare,
            cl.is_health_good AS isHealthGood,
            cl.is_pain AS isPain,
            cl.is_edema AS isEdema,
            cl.is_skin_issue AS isSkinIssue,
            cl.is_body_etc AS isBodyEtc,
            cl.is_mood_calm AS isMoodCalm,
            cl.is_mood_anxious AS isMoodAnxious,
            cl.is_mood_depressed AS isMoodDepressed,
            cl.is_mood_angry AS isMoodAngry,
            cl.is_mood_etc AS isMoodEtc,
            cl.is_sleep_lack AS isSleepLack,
            cl.is_nap_excess AS isNapExcess,
            cl.special_note AS specialNote
        FROM care_logs cl
                 LEFT JOIN beneficiary b ON cl.beneficiary_id = b.id
                 LEFT JOIN (
                     SELECT beneficiary_id, id
                     FROM beneficiary_care_level bcl1
                     WHERE start_date = (
                         SELECT MAX(start_date)
                         FROM beneficiary_care_level bcl2
                         WHERE bcl2.beneficiary_id = bcl1.beneficiary_id
                     )
                 ) bcl ON b.id = bcl.beneficiary_id
                 LEFT JOIN beneficiary_count bc ON bcl.id = bc.beneficiary_care_level_id
                 LEFT JOIN m_care_level mcl ON bc.m_care_level_id = mcl.id
        WHERE cl.log_id = #{logId}
          AND cl.is_deleted = FALSE
    </select>

</mapper>
