<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.ateam.oncare.careworker.query.mapper.BeneficiaryQueryMapper">

    <!-- 요양보호사에게 배정된 수급자 목록 조회 (matching 테이블 기준) -->
    <select id="selectAssignedBeneficiaries" resultType="org.ateam.oncare.careworker.query.dto.MyBeneficiaryDto">
        SELECT DISTINCT
            b.id AS beneficiaryId,
            b.name,
            b.gender,
            b.birthdate,
            TIMESTAMPDIFF(YEAR, b.birthdate, CURRENT_DATE) AS age,
            b.address,
            b.phone,
            COALESCE(mcl.level, '등급없음') AS careLevel,
            (SELECT GROUP_CONCAT(DISTINCT mst.name ORDER BY mst.name SEPARATOR ', ')
             FROM visit_schedule vs
                      JOIN m_service_type mst ON vs.service_type_id = mst.id
             WHERE vs.beneficiary_id = b.id
               AND vs.care_worker_id = cw.id
            ) AS serviceTypes
        FROM matching m
                 JOIN care_worker cw ON m.care_worker_id = cw.id
                 JOIN beneficiary b ON m.beneficiary_id = b.id
                 LEFT JOIN (
                     SELECT beneficiary_id, id
                     FROM beneficiary_care_level bcl1
                     WHERE start_date = (
                         SELECT MAX(start_date)
                         FROM beneficiary_care_level bcl2
                         WHERE bcl2.beneficiary_id = bcl1.beneficiary_id
                     )
                 ) bcl ON b.id = bcl.beneficiary_id
                 LEFT JOIN beneficiary_count bc ON bcl.id = bc.beneficiary_care_level_id
                 LEFT JOIN m_care_level mcl ON bc.m_care_level_id = mcl.id
        WHERE cw.employee_id = #{employeeId}
          AND m.status = 'Y'
        ORDER BY b.name
    </select>

    <!-- 요양보호사에게 배정된 특정 수급자 상세 조회 (matching 테이블 기준) -->
    <select id="selectAssignedBeneficiaryDetail" resultType="org.ateam.oncare.careworker.query.dto.MyBeneficiaryDto">
        SELECT DISTINCT
            b.id AS beneficiaryId,
            b.name,
            b.gender,
            b.birthdate,
            TIMESTAMPDIFF(YEAR, b.birthdate, CURRENT_DATE) AS age,
            b.address,
            b.phone,
            COALESCE(mcl.level, '등급없음') AS careLevel,
            (SELECT GROUP_CONCAT(DISTINCT mst.name ORDER BY mst.name SEPARATOR ', ')
             FROM visit_schedule vs
                      JOIN m_service_type mst ON vs.service_type_id = mst.id
             WHERE vs.beneficiary_id = b.id
               AND vs.care_worker_id = cw.id
            ) AS serviceTypes
        FROM matching m
                 JOIN care_worker cw ON m.care_worker_id = cw.id
                 JOIN beneficiary b ON m.beneficiary_id = b.id
                 LEFT JOIN (
                     SELECT beneficiary_id, id
                     FROM beneficiary_care_level bcl1
                     WHERE start_date = (
                         SELECT MAX(start_date)
                         FROM beneficiary_care_level bcl2
                         WHERE bcl2.beneficiary_id = bcl1.beneficiary_id
                     )
                 ) bcl ON b.id = bcl.beneficiary_id
                 LEFT JOIN beneficiary_count bc ON bcl.id = bc.beneficiary_care_level_id
                 LEFT JOIN m_care_level mcl ON bc.m_care_level_id = mcl.id
        WHERE cw.employee_id = #{employeeId}
          AND b.id = #{beneficiaryId}
          AND m.status = 'Y'
        LIMIT 1
    </select>

</mapper>
