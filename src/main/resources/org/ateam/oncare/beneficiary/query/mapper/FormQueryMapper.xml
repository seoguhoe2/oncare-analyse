<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.ateam.oncare.beneficiary.query.mapper.FormQueryMapper">

    <!--
      수급자별 서류 목록 조회 규칙
      1) 카테고리 1~5 : 기본 노출
      2) 카테고리 9   : 위험요소에 '치매'가 있는 경우만 노출
      3) 카테고리 6~8 : visit_schedule 서비스 유형에 따라 노출
    -->

    <select id="selectFormsForBeneficiary"
            resultType="org.ateam.oncare.beneficiary.query.dto.FormListItem">

        SELECT
        af.id                      AS formId,
        af.size AS fileSize,
        af.original_file_name      AS originalFileName,
        DATE_FORMAT(af.created_at, '%Y-%m-%d') AS createdAt,
        af.mime_type               AS mimeType,
        af.re_file_name            AS reFileName,
        af.file_path               AS filePath,
        mfc.name                   AS categoryName
        FROM application_form af
        JOIN m_form_category mfc
        ON mfc.id = af.form_category_id
        WHERE
        (
        <!-- 1~5 기본 서류 -->
        af.form_category_id IN (1,2,3,4,5)

        <!-- (9) 산정특례 신청서 : 치매 risk 있을 때만 -->
        OR (
        af.form_category_id = 9
        AND EXISTS (
        SELECT 1
        FROM riskOfMember rom
        JOIN m_risk_factor rf
        ON rf.id = rom.risk_id
        WHERE rom.beneficiary_id = #{beneficiaryId}
        AND rf.name = '치매'
        )
        )

        <!-- (6) 제공기록지 - 방문요양 -->
        OR (
        af.form_category_id = 6
        AND EXISTS (
        SELECT 1
        FROM visit_schedule vs
        WHERE vs.beneficiary_id = #{beneficiaryId}
        AND vs.service_type_id = 1
        AND vs.visit_status = 'DONE'
        )
        )

        <!-- (7) 제공기록지 - 방문목욕 -->
        OR (
        af.form_category_id = 7
        AND EXISTS (
        SELECT 1
        FROM visit_schedule vs
        WHERE vs.beneficiary_id = #{beneficiaryId}
        AND vs.service_type_id = 2
        AND vs.visit_status = 'DONE'
        )
        )

        <!-- (8) 제공기록지 - 방문간호 -->
        OR (
        af.form_category_id = 8
        AND EXISTS (
        SELECT 1
        FROM visit_schedule vs
        WHERE vs.beneficiary_id = #{beneficiaryId}
        AND vs.service_type_id = 3
        AND vs.visit_status = 'DONE'
        )
        )
        )
        ORDER BY af.form_category_id ASC, af.created_at DESC

    </select>

</mapper>
