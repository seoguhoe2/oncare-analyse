<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.ateam.oncare.beneficiary.query.mapper.CounselingLogsMapper">

    <!-- 1) 상담 탭 목록 조회 (수급자별) -->
    <select id="selectCounselingList"
            resultType="org.ateam.oncare.beneficiary.query.dto.response.CounselingListResponse$Item">

        SELECT
        cl.counseling_id AS counselingId,
        DATE_FORMAT(cl.counseling_date, '%Y-%m-%d') AS counselingDate,
        cl.counseling_type AS counselingType,
        cl.satisfaction AS satisfaction,
        cl.visit_purpose AS visitPurpose,
        cl.beneficiary_id AS beneficiaryId
        FROM counseling_logs cl
        WHERE cl.beneficiary_id = #{beneficiaryId}
        ORDER BY cl.counseling_date DESC, cl.counseling_id DESC

    </select>


    <!-- 2) 상담 상세 모달 조회 -->
    <select id="selectCounselingDetail"
            resultType="org.ateam.oncare.beneficiary.query.dto.response.CounselingDetailResponse">

        SELECT
        cl.counseling_id AS counselingId,
        DATE_FORMAT(cl.counseling_date, '%Y-%m-%d') AS counselingDate,
        cl.counseling_type AS counselingType,

        e.name AS careWorkerName,
        b.name AS beneficiaryName,
        cl.beneficiary_id AS beneficiaryId,

        cl.attendees AS attendees,

        cl.visit_purpose AS visitPurpose,
        cl.discussion_content AS discussionContent,
        cl.agreement_content AS agreementContent,
        DATE_FORMAT(cl.next_visit_date, '%Y-%m-%d') AS nextVisitDate

        FROM counseling_logs cl
        JOIN beneficiary b ON b.id = cl.beneficiary_id
        JOIN care_worker cw ON cw.id = cl.care_worker_id
        JOIN employee e ON e.id = cw.employee_id
        JOIN m_job mj ON mj.id = e.job_code

        WHERE cl.beneficiary_id = #{beneficiaryId}
        AND cl.counseling_id = #{counselingId}
        AND mj.id = 5   <!-- 요양보호사 -->

    </select>

</mapper>
