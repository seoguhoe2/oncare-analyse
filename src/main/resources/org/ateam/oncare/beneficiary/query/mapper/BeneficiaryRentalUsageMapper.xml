<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.ateam.oncare.beneficiary.query.mapper.BeneficiaryRentalUsageMapper">

    <!-- ✅ 현재 렌탈: 날짜 기준(오늘 포함)+ 오늘날짜기준으로 유효한계약만(상태값(접수/유지 등) 필터링 x -->
    <select id="selectCurrentRentals"
            parameterType="long"
            resultType="org.ateam.oncare.beneficiary.query.dto.response.RentalUsageResponse$RentalItem">

        SELECT
        rc.id AS rentalContractId,
        cp.id AS productAssetId,
        mcp.name AS productName,

        cs.name AS contractStatusName,

        DATE_FORMAT(rc.start_date, '%Y-%m-%d') AS startDate,
        DATE_FORMAT(rc.end_date,   '%Y-%m-%d') AS endDate,

        CAST(cp.rental_amount AS SIGNED) AS monthlyAmount,

        /* 계약 개월수 컬럼 산정(끝나는 달 포함) */
        CASE
        WHEN rc.end_date IS NULL THEN NULL
        ELSE TIMESTAMPDIFF(MONTH, rc.start_date, rc.end_date) + 1
        END AS durationMonths

        FROM rental_contract rc
        JOIN contract_status cs ON cs.id = rc.contract_status_cd
        JOIN rental_product rp ON rp.rental_contract_cd = rc.id
        JOIN rental_product_status rps ON rps.id = rp.rental_status_id
        JOIN care_product cp ON cp.id = rp.product_id
        JOIN m_care_product mcp ON mcp.id = cp.product_cd

        WHERE rc.beneficiary_id = #{beneficiaryId}
        /* ✅ 현재(진행중) = 오늘 기준 유효한 계약만 */
        AND rc.start_date &lt;= CURDATE()
        AND (rc.end_date IS NULL OR rc.end_date &gt;= CURDATE())    <!-- 오늘 기준 유효한 계약만 남게됨 -->

        ORDER BY rc.start_date DESC, rc.id DESC, cp.id ASC
    </select>


    <!-- ✅ 과거 렌탈: 날짜 기준 + (상태값(접수/유지 등) 필터링 x)-->
    <select id="selectRentalHistories"
            parameterType="long"
            resultType="org.ateam.oncare.beneficiary.query.dto.response.RentalUsageResponse$RentalItem">

        SELECT
        rc.id AS rentalContractId,
        cp.id AS productAssetId,
        mcp.name AS productName,

        cs.name AS contractStatusName,

        DATE_FORMAT(rc.start_date, '%Y-%m-%d') AS startDate,
        DATE_FORMAT(rc.end_date,   '%Y-%m-%d') AS endDate,

        CAST(cp.rental_amount AS SIGNED) AS monthlyAmount,

        CASE
        WHEN rc.end_date IS NULL THEN NULL
        ELSE TIMESTAMPDIFF(MONTH, rc.start_date, rc.end_date) + 1
        END AS durationMonths

        FROM rental_contract rc
        JOIN contract_status cs ON cs.id = rc.contract_status_cd
        JOIN rental_product rp ON rp.rental_contract_cd = rc.id
        JOIN rental_product_status rps ON rps.id = rp.rental_status_id
        JOIN care_product cp ON cp.id = rp.product_id
        JOIN m_care_product mcp ON mcp.id = cp.product_cd

        WHERE rc.beneficiary_id = #{beneficiaryId}
        /* ✅ 과거(종료) = end_date가 있고 오늘보다 이전 */
        AND rc.end_date IS NOT NULL
        AND rc.end_date &lt; CURDATE()

        ORDER BY rc.end_date DESC, rc.start_date DESC, rc.id DESC, cp.id ASC
    </select>


    <!-- ✅ 렌탈 모달 상세 조회 (계약 1건 + 용품 1건) + end_date기준(상태값 필터링x)-->
    <select id="selectRentalContractDetail"
            resultType="org.ateam.oncare.beneficiary.query.dto.response.RentalContractDetailResponse">

        SELECT
        rc.id AS rentalContractId,
        cp.id AS productAssetId,
        mcp.name AS productName,

        cs.name AS contractStatusName,

        DATE_FORMAT(rc.start_date, '%Y-%m-%d') AS contractDate,
        DATE_FORMAT(rc.start_date, '%Y-%m-%d') AS startDate,
        DATE_FORMAT(rc.end_date,   '%Y-%m-%d') AS endDate,

        CAST(cp.rental_amount AS SIGNED) AS monthlyAmount,

        CASE
        WHEN rc.end_date IS NULL THEN NULL
        ELSE TIMESTAMPDIFF(MONTH, rc.start_date, rc.end_date) + 1
        END AS durationMonths,

        CASE
        WHEN rc.end_date IS NULL THEN NULL
        ELSE CAST(cp.rental_amount AS SIGNED)
        * (TIMESTAMPDIFF(MONTH, rc.start_date, rc.end_date) + 1)
        END AS totalCost

        FROM rental_contract rc
        JOIN contract_status cs ON cs.id = rc.contract_status_cd
        JOIN rental_product rp ON rp.rental_contract_cd = rc.id
        JOIN care_product cp ON cp.id = rp.product_id
        JOIN m_care_product mcp ON mcp.id = cp.product_cd

        WHERE rc.beneficiary_id = #{beneficiaryId}
        AND rc.id = #{rentalContractId}
        AND cp.id = #{productAssetId}

        LIMIT 1
    </select>

</mapper>
