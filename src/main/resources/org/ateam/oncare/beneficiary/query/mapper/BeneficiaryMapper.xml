<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.ateam.oncare.beneficiary.query.mapper.BeneficiaryMapper">

    <!-- =====================================================
         RESULT MAP
         ===================================================== -->
    <resultMap id="BeneficiaryListMap"
               type="org.ateam.oncare.beneficiary.query.dto.response.BeneficiaryListItemResponse">

        <id     property="beneficiaryId" column="beneficiary_id"/>
        <result property="name"          column="beneficiary_name"/>

        <result property="careLevel"     column="care_level"/>
        <!-- ✅ 산정된 문자열 저/중/고위험 -->
        <result property="riskLevel"     column="risk_level"/>

        <result property="managerName"   column="manager_name"/>
        <result property="serviceType"   column="service_type"/>

        <result property="status"        column="service_status"/>
    </resultMap>


    <!-- =====================================================
         SQL FRAGMENTS
         ===================================================== -->

    <!-- ✅ 위험요소 점수 합산 (수급자별) -->
    <sql id="RiskSumJoin">
        LEFT JOIN (
        SELECT
        rom.beneficiary_id,
        SUM(rf.score) AS risk_total
        FROM riskOfMember rom
        JOIN m_risk_factor rf ON rf.id = rom.risk_id
        GROUP BY rom.beneficiary_id
        ) rsum ON rsum.beneficiary_id = b.id
    </sql>

    <!-- 현재 장기요양등급 + 담당자 + 서비스타입 -->
    <sql id="BaseJoin">

        <!-- 현재 장기요양등급 -->
        LEFT JOIN beneficiary_care_level bcl
        ON bcl.beneficiary_id = b.id
        AND bcl.id = (
        SELECT bc2.beneficiary_care_level_id
        FROM beneficiary_count bc2
        WHERE bc2.beneficiary_care_level_id = bcl.id
        LIMIT 1
        )

        LEFT JOIN beneficiary_count bc
        ON bc.beneficiary_care_level_id = bcl.id

        LEFT JOIN m_care_level mcl
        ON mcl.id = bc.m_care_level_id

        <!-- ✅ 위험등급(b.risk_id) 조인은 제거! (위험요소 합산으로 산정할 거라서) -->
        <include refid="RiskSumJoin"/>

        <!-- 담당 요양보호사 -->
        LEFT JOIN matching mt
        ON mt.beneficiary_id = b.id
        AND mt.status = 'Y'

        LEFT JOIN care_worker cw
        ON cw.id = mt.care_worker_id

        LEFT JOIN employee e
        ON e.id = cw.employee_id

        <!-- 서비스 타입 (첫 일정 기준) -->
        LEFT JOIN m_service_type mst
        ON mst.id = (
        SELECT bs.service_type_id
        FROM beneficiary_schedule bs
        WHERE bs.beneficiary_id = b.id
        ORDER BY bs.start_time ASC
        LIMIT 1
        )
    </sql>

    <!-- 필터링&검색 -->
    <sql id="BaseWhere">
        <where>
            <!-- ✅ 서비스 상태 (ACTIVE/INACTIVE → 1/0 매핑) -->
            <if test="status != null and status != ''">
                AND b.status =
                <choose>
                    <when test="status == '서비스 중'"> 1 </when>
                    <when test="status == '서비스 해지'"> 0 </when>
                    <otherwise> #{status} </otherwise>
                </choose>
            </if>

            <!-- ✅ 위험등급 필터도 "산정된 등급"으로 처리 (riskLevelId: 1/2/3) -->
            <if test="riskLevelId != null">
                AND
                <choose>
                    <when test="riskLevelId == 1">
                        IFNULL(rsum.risk_total, 0) &lt; 10
                    </when>
                    <when test="riskLevelId == 2">
                        IFNULL(rsum.risk_total, 0) &gt;= 10
                        AND IFNULL(rsum.risk_total, 0) &lt; 15
                    </when>
                    <when test="riskLevelId == 3">
                        IFNULL(rsum.risk_total, 0) &gt;= 15
                    </when>
                    <otherwise>
                        1=1
                    </otherwise>
                </choose>
            </if>

            <!-- 장기요양등급 (현재) -->
            <if test="careLevelId != null">
                AND mcl.id = #{careLevelId}
            </if>

            <!-- 검색 -->
            <if test="keyword != null and keyword != ''">
                AND (
                b.name    LIKE CONCAT('%', #{keyword}, '%')
                OR b.phone LIKE CONCAT('%', #{keyword}, '%')
                OR b.address LIKE CONCAT('%', #{keyword}, '%')
                )
            </if>
        </where>
    </sql>

    <!-- 정렬기준 -->
    <sql id="OrderBy">
        ORDER BY
        <choose>
            <when test="sort == 'NAME'">
                b.name
            </when>

            <!-- ✅ 산정된 위험등급 기준 정렬: (저=1, 중=2, 고=3) -->
            <when test="sort == 'RISK'">
                CASE
                WHEN IFNULL(rsum.risk_total, 0) &lt; 10 THEN 1
                WHEN IFNULL(rsum.risk_total, 0) &lt; 15 THEN 2
                ELSE 3
                END
            </when>

            <when test="sort == 'CARE_LEVEL'">
                mcl.level
            </when>

            <otherwise>
                b.name
            </otherwise>
        </choose>

        <choose>
            <when test="direction == 'DESC'"> DESC </when>
            <otherwise> ASC </otherwise>
        </choose>
    </sql>


    <!-- =====================================================
         QUERIES
         ===================================================== -->

    <!-- 수급자 전체 조회 -->
    <select id="selectBeneficiaries"
            parameterType="org.ateam.oncare.beneficiary.query.dto.request.BeneficiarySearchRequest"
            resultMap="BeneficiaryListMap">

        SELECT
        b.id   AS beneficiary_id,
        b.name AS beneficiary_name,

        mcl.level AS care_level,

        <!-- ✅ risk_total로 저/중/고위험 "문자" 만들어서 내려줌 -->
        CASE
        WHEN IFNULL(rsum.risk_total, 0) &lt; 10 THEN '저위험'
        WHEN IFNULL(rsum.risk_total, 0) &lt; 15 THEN '중위험'
        ELSE '고위험'
        END AS risk_level,

        e.name   AS manager_name,
        mst.name AS service_type,

        CASE
        WHEN b.status = 1 THEN '서비스 중'
        ELSE '서비스 해지'
        END AS service_status

        FROM beneficiary b
        <include refid="BaseJoin"/>
        <include refid="BaseWhere"/>
        <include refid="OrderBy"/>

        LIMIT #{size}
        OFFSET #{offset}
    </select>


    <!-- 전체 건수 -->
    <select id="countBeneficiaries"
            parameterType="org.ateam.oncare.beneficiary.query.dto.request.BeneficiarySearchRequest"
            resultType="long">

        SELECT COUNT(DISTINCT b.id)
        FROM beneficiary b
        <include refid="BaseJoin"/>
        <include refid="BaseWhere"/>
    </select>

</mapper>
