<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.ateam.oncare.beneficiary.query.mapper.BeneficiaryMapper">

    <!-- =====================================================
         RESULT MAP
         ===================================================== -->
    <resultMap id="BeneficiaryListMap"
               type="org.ateam.oncare.beneficiary.query.dto.response.BeneficiaryListItemResponse">

        <id     property="beneficiaryId" column="beneficiary_id"/>
        <result property="name"          column="beneficiary_name"/>

        <result property="careLevel"     column="care_level"/>
        <result property="riskLevel"     column="risk_level"/>

        <!-- ✅ 수급자당 요양보호사 1명 => Long 유지 가능 -->
        <result property="careWorkerId"  column="care_worker_id"/>
        <result property="managerName"   column="care_worker_name"/>

        <!-- ✅ 서비스유형은 여러 개 가능 => 문자열로 묶어서 -->
        <result property="serviceType"   column="service_types"/>

        <result property="status"        column="service_status"/>
    </resultMap>


    <!-- =====================================================
         SQL FRAGMENTS
         ===================================================== -->

    <!-- ✅ 위험요소 점수 합산 (수급자별) -->
    <sql id="RiskSumJoin">
        LEFT JOIN (
        SELECT
        rom.beneficiary_id,
        SUM(rf.score) AS risk_total
        FROM riskOfMember rom
        JOIN m_risk_factor rf ON rf.id = rom.risk_id
        GROUP BY rom.beneficiary_id
        ) rsum ON rsum.beneficiary_id = b.id
    </sql>

    <!-- ✅ DONE 기준: (1) 요양보호사 1명(대표: 최신 DONE) + (2) 서비스유형 여러개 집계 -->
    <sql id="DoneAggJoin">

        <!-- (1) 최신 DONE 1건의 요양보호사 -->
        LEFT JOIN visit_schedule vs_done
        ON vs_done.vs_id = (
        SELECT vs2.vs_id
        FROM visit_schedule vs2
        WHERE vs2.beneficiary_id = b.id
<!--        AND vs2.visit_status = 'DONE'-->
        ORDER BY vs2.start_dt DESC
        LIMIT 1
        )

        LEFT JOIN care_worker cw
        ON cw.id = vs_done.care_worker_id

        LEFT JOIN employee ce
        ON ce.id = cw.employee_id

        <!-- (2) DONE 방문에서 서비스유형은 여러개 가능 => 집계해서 1행으로 -->
        LEFT JOIN (
        SELECT
        vs.beneficiary_id,
        GROUP_CONCAT(DISTINCT mst.name ORDER BY mst.name SEPARATOR ', ') AS service_types
        FROM visit_schedule vs
        JOIN m_service_type mst ON mst.id = vs.service_type_id
        GROUP BY vs.beneficiary_id
        ) st ON st.beneficiary_id = b.id

    </sql>

    <!-- 현재 장기요양등급 + 위험 + (DONE 기준) 요양보호사/서비스유형 -->
    <sql id="BaseJoin">

        LEFT JOIN beneficiary_care_level bcl
        ON bcl.beneficiary_id = b.id
        AND bcl.id = (
        SELECT bc2.beneficiary_care_level_id
        FROM beneficiary_count bc2
        WHERE bc2.beneficiary_care_level_id = bcl.id
        LIMIT 1
        )

        LEFT JOIN beneficiary_count bc
        ON bc.beneficiary_care_level_id = bcl.id

        LEFT JOIN m_care_level mcl
        ON mcl.id = bc.m_care_level_id

        <include refid="RiskSumJoin"/>
        <include refid="DoneAggJoin"/>
    </sql>

    <!-- 필터링&검색 -->
    <sql id="BaseWhere">
        <where>
            <if test="status != null and status != ''">
                AND b.status =
                <choose>
                    <when test="status == '서비스 중'"> 1 </when>
                    <when test="status == '서비스 해지'"> 0 </when>
                    <otherwise> #{status} </otherwise>
                </choose>
            </if>

            <if test="riskLevelId != null">
                AND
                <choose>
                    <when test="riskLevelId == 1">
                        IFNULL(rsum.risk_total, 0) &lt; 10
                    </when>
                    <when test="riskLevelId == 2">
                        IFNULL(rsum.risk_total, 0) &gt;= 10
                        AND IFNULL(rsum.risk_total, 0) &lt; 15
                    </when>
                    <when test="riskLevelId == 3">
                        IFNULL(rsum.risk_total, 0) &gt;= 15
                    </when>
                    <otherwise>
                        1=1
                    </otherwise>
                </choose>
            </if>

            <if test="careLevelId != null">
                AND mcl.id = #{careLevelId}
            </if>

            <if test="keyword != null and keyword != ''">
                AND (
                b.name    LIKE CONCAT('%', #{keyword}, '%')
                OR b.phone LIKE CONCAT('%', #{keyword}, '%')
                OR b.address LIKE CONCAT('%', #{keyword}, '%')
                )
            </if>
        </where>
    </sql>

    <!-- 정렬기준 -->
    <sql id="OrderBy">
        ORDER BY
        <choose>
            <when test="sort == 'NAME'">
                b.name
            </when>

            <when test="sort == 'RISK'">
                CASE
                WHEN IFNULL(rsum.risk_total, 0) &lt; 10 THEN 1
                WHEN IFNULL(rsum.risk_total, 0) &lt; 15 THEN 2
                ELSE 3
                END
            </when>

            <when test="sort == 'CARE_LEVEL'">
                mcl.level
            </when>

            <otherwise>
                b.name
            </otherwise>
        </choose>

        <choose>
            <when test="direction == 'DESC'"> DESC </when>
            <otherwise> ASC </otherwise>
        </choose>
    </sql>


    <!-- =====================================================
         QUERIES
         ===================================================== -->

    <select id="selectBeneficiaries"
            parameterType="org.ateam.oncare.beneficiary.query.dto.request.BeneficiarySearchRequest"
            resultMap="BeneficiaryListMap">

        SELECT
        b.id   AS beneficiary_id,
        b.name AS beneficiary_name,

        mcl.level AS care_level,

        CASE
        WHEN IFNULL(rsum.risk_total, 0) &lt; 10 THEN '저위험'
        WHEN IFNULL(rsum.risk_total, 0) &lt; 15 THEN '중위험'
        ELSE '고위험'
        END AS risk_level,

        cw.id      AS care_worker_id,
        ce.name    AS care_worker_name,

        st.service_types AS service_types,

        CASE
        WHEN b.status = 1 THEN '서비스 중'
        ELSE '서비스 해지'
        END AS service_status

        FROM beneficiary b
        <include refid="BaseJoin"/>
        <include refid="BaseWhere"/>
        <include refid="OrderBy"/>

        LIMIT #{size}
        OFFSET #{offset}
    </select>

    <select id="countBeneficiaries"
            parameterType="org.ateam.oncare.beneficiary.query.dto.request.BeneficiarySearchRequest"
            resultType="long">

        SELECT COUNT(DISTINCT b.id)
        FROM beneficiary b
        <include refid="BaseJoin"/>
        <include refid="BaseWhere"/>
    </select>

</mapper>
