<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.ateam.oncare.beneficiary.query.mapper.AiCareQueryMapper">

    <!-- ✅ 최신 1건: ai_id DESC (또는 ai_create_at DESC) -->
    <select id="selectLatestAiSummary"
            resultType="org.ateam.oncare.beneficiary.query.dto.response.AiCareSummaryResponse">

        SELECT
        ac.ai_id            AS aiId,
        ac.beneficiary_id   AS beneficiaryId,
        ac.ai_month         AS month,
        ac.ai_content       AS summaryText,

        ac.ai_last_log_id   AS lastLogId,
        ac.ai_logs_count    AS logsCount,
        DATE_FORMAT(ac.ai_last_service_date, '%Y-%m-%d') AS lastServiceDate,
        DATE_FORMAT(ac.ai_create_at, '%Y-%m-%d %H:%i:%s') AS createdAt,

        ac.ai_input_tokens  AS inputTokens,
        ac.ai_output_tokens AS outputTokens,
        ac.ai_total_tokens  AS totalTokens

        FROM ai_care ac
        WHERE ac.beneficiary_id = #{beneficiaryId}
        AND ac.ai_month = #{month}
        ORDER BY ac.ai_id DESC
        LIMIT 1
    </select>

</mapper>
