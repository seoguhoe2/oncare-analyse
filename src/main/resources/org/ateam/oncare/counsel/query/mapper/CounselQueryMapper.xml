<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.ateam.oncare.counsel.query.mapper.CounselQueryMapper">
    <resultMap id="customerListResponse" type="org.ateam.oncare.counsel.query.dto.CustomerListResponse">
        <id property="customerId" column="customer_id"/>
        <result property="name" column="name"/>
        <result property="phone" column="phone"/>
        <result property="customerCategoryName" column="customer_category"/>
        <result property="consultDate" column="last_consult_date"/>
        <result property="consultCount" column="consult_count"/>
        <result property="guardianName" column="guardian_name"/>
        <result property="guardianPhone" column="guardian_phone"/>
        <result property="customerType" column="customer_type"/>
    </resultMap>
    <select id="findAllCustomers" resultMap="customerListResponse">
        SELECT
               customer_id,
               name,
               phone,
               customer_category,
               last_counsel_date,
               consult_count,
               guardian_name,
               guardian_phone
          FROM (
                 SELECT
                     b.id AS customer_id,
                     b.name,
                     b.phone,
                     CASE
                         WHEN b.status = 0 THEN '이탈고객'
                         ELSE '기존고객'
                         END AS customer_category,
                     b.last_counsel_date,
                     (SELECT COUNT(*) FROM counsel_history WHERE beneficiary_id = b.id) AS consult_count,
                     g.name AS guardian_name,
                     g.phone AS guardian_phone
                 FROM beneficiary b
                          LEFT JOIN guardian g ON b.id = g.beneficiary_id AND g.is_primary = 'Y'

                 UNION ALL

                 SELECT
                     p.id AS customer_id,
                     p.name,
                     p.phone,
                     CASE
                         WHEN p.willingness = 'N' THEN '이탈고객'
                         WHEN p.current_stage = 1 AND p.last_counsel_date &lt; DATE_SUB(NOW(), INTERVAL 3 DAY) THEN '이탈고객'
                         WHEN p.current_stage = 2 AND p.last_counsel_date &lt; DATE_SUB(NOW(), INTERVAL 70 DAY) THEN '이탈고객'
                         WHEN p.current_stage = 3 AND p.last_counsel_date &lt; DATE_SUB(NOW(), INTERVAL 20 DAY) THEN '이탈고객'
                         ELSE '잠재고객'
                         END AS customer_category,
                     p.last_counsel_date,
                     (SELECT COUNT(*) FROM counsel_history WHERE potential_id = p.id) AS consult_count,
                     NULL AS guardian_name,
                     NULL AS guardian_phone
                 FROM potential_customer p
                 WHERE p.current_stage &lt; 4
             ) AS total_list
        ORDER BY last_counsel_date DESC
    </select>
    <select id="searchCustomersByPhone" resultMap="customerListResponse">
        SELECT
            customer_id,
            name,
            phone,
            customer_category,
            last_counsel_date,
            consult_count,
            guardian_name,
            guardian_phone
        FROM (
                 SELECT
                     b.id AS customer_id,
                     b.name,
                     b.phone,
                     CASE WHEN b.status = 0 THEN '이탈고객' ELSE '기존고객' END AS customer_category,
                     b.last_counsel_date,
                     (SELECT COUNT(*) FROM counsel_history WHERE beneficiary_id = b.id) AS consult_count,
                     g.name AS guardian_name,
                     g.phone AS guardian_phone
                 FROM beneficiary b
                          LEFT JOIN guardian g ON b.id = g.beneficiary_id AND g.is_primary = 'Y'
                 WHERE REPLACE(b.phone, '-', '') LIKE CONCAT('%', #{keyword}, '%')
                    OR REPLACE(g.phone, '-', '') LIKE CONCAT('%', #{keyword}, '%')

                 UNION ALL

                 SELECT
                     p.id AS customer_id,
                     p.name,
                     p.phone,
                     CASE
                         WHEN p.willingness = 'N' THEN '이탈고객'
                         WHEN p.current_stage = 1 AND p.last_counsel_date &lt; DATE_SUB(NOW(), INTERVAL 3 DAY) THEN '이탈고객'
                         WHEN p.current_stage = 2 AND p.last_counsel_date &lt; DATE_SUB(NOW(), INTERVAL 60 DAY) THEN '이탈고객'
                         WHEN p.current_stage = 3 AND p.last_counsel_date &lt; DATE_SUB(NOW(), INTERVAL 14 DAY) THEN '이탈고객'
                         ELSE '잠재고객'
                         END AS customer_category,
                     p.last_counsel_date,
                     (SELECT COUNT(*) FROM counsel_history WHERE potential_id = p.id) AS consult_count,
                     NULL AS guardian_name,
                     NULL AS guardian_phone
                 FROM potential_customer p
                 WHERE p.current_stage &lt; 4
                   AND REPLACE(p.phone, '-', '') LIKE CONCAT('%', #{keyword}, '%')
             ) AS total_list
        ORDER BY last_counsel_date DESC
    </select>
    <select id="searchCustomersByName" resultMap="customerListResponse">
        SELECT
            customer_id,
            name,
            phone,
            customer_category,
            last_counsel_date,
            consult_count,
            guardian_name,
            guardian_phone
        FROM (
                 SELECT
                     b.id AS customer_id,
                     b.name,
                     b.phone,
                     CASE WHEN b.status = 0 THEN '이탈고객' ELSE '기존고객' END AS customer_category,
                     b.last_counsel_date,
                     (SELECT COUNT(*) FROM counsel_history WHERE beneficiary_id = b.id) AS consult_count,
                     g.name AS guardian_name,
                     g.phone AS guardian_phone
                 FROM beneficiary b
                          LEFT JOIN guardian g ON b.id = g.beneficiary_id AND g.is_primary = 'Y'
                 WHERE b.name LIKE CONCAT('%', #{keyword}, '%')
                    OR g.name LIKE CONCAT('%', #{keyword}, '%')

                 UNION ALL

                 SELECT
                     p.id AS customer_id,
                     p.name,
                     p.phone,
                     CASE
                         WHEN p.willingness = 'N' THEN '이탈고객'
                         WHEN p.current_stage = 1 AND p.last_counsel_date &lt; DATE_SUB(NOW(), INTERVAL 3 DAY) THEN '이탈고객'
                         WHEN p.current_stage = 2 AND p.last_counsel_date &lt; DATE_SUB(NOW(), INTERVAL 60 DAY) THEN '이탈고객'
                         WHEN p.current_stage = 3 AND p.last_counsel_date &lt; DATE_SUB(NOW(), INTERVAL 14 DAY) THEN '이탈고객'
                         ELSE '잠재고객'
                         END AS customer_category,
                     p.last_counsel_date,
                     (SELECT COUNT(*) FROM counsel_history WHERE potential_id = p.id) AS consult_count,
                     NULL AS guardian_name,
                     NULL AS guardian_phone
                 FROM potential_customer p
                 WHERE p.current_stage &lt; 4
                   AND p.name LIKE CONCAT('%', #{keyword}, '%')
             ) AS total_list
        ORDER BY last_counsel_date DESC
    </select>
    <resultMap id="counselListResponse" type="org.ateam.oncare.counsel.query.dto.CounselListResponse">
        <id property="counselHistoryId" column="counsel_history_id"/>
        <result property="detail" column="detail"/>
        <result property="consultDate" column="consult_date"/>
        <result property="consultTime" column="consult_time"/>
        <result property="counselorName" column="counselor_name"/>
        <result property="counselCategoryName" column="m_counsel_category_name"/>
    </resultMap>
    <select id="findCounselsByCustomerId" resultMap="counselListResponse">
        SELECT
            ch.id                                    AS counsel_history_id,
            ch.content                               AS detail,
            DATE_FORMAT(ch.consult_date, '%Y-%m-%d') AS consult_date,
            DATE_FORMAT(ch.consult_date, '%H:%i')    AS consult_time,

            -- [1] Employee 테이블 조인 결과 (resultMap의 column 속성에 맞춰 별칭 지정)
            e.name                                   AS counselor_name,

            -- [2] Category 테이블 조인 결과
            mcc.name                                 AS m_counsel_category_name

          FROM counsel_history ch
                 -- 상담원 정보 조인 (FK가 counselor_id라고 가정)
                 LEFT JOIN employee e ON ch.counselor_id = e.id
            -- 상담 카테고리 정보 조인 (FK가 consult_category 라고 가정)
                 LEFT JOIN m_counsel_category mcc ON ch.consult_category_id = mcc.id

        WHERE ch.beneficiary_id = #{customerId}
        ORDER BY ch.consult_date DESC
            LIMIT #{limit} OFFSET #{offset}
    </select>

</mapper>